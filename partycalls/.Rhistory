switched_votes <- seq_len(rc$m)
match_counter <- 0
counter <- 0
record_of_coding <- list()
record_of_pvals <- list()
while (counter <= count_min |
(counter < count_max & match_counter < match_count_min)) {
counter <- counter + 1
record_of_coding[[counter]] <- noncalls
old_noncalls <- noncalls
old_switched_votes <- switched_votes
pvals <- code_party_calls_1step(rc, DT, noncalls)
record_of_pvals[[counter]] <- pvals
noncalls <- which(pvals > pval_threshold)
calls <- setdiff(seq_len(rc$m), old_noncalls)
if (sim_annealing == TRUE) {
n_random_switches <- floor(rc$m * .2 * max(0, 1 - counter / 50) ^ 2)
} else {
n_random_switches <- 0
}
if (n_random_switches > 0) {
calls_to_switch <- sample(calls, n_random_switches)
noncalls_to_switch <- sample(noncalls, n_random_switches)
calls_to_keep <- setdiff(calls, calls_to_switch)
noncalls_to_keep <- setdiff(noncalls, noncalls_to_switch)
calls <- c(calls_to_keep, noncalls_to_switch)
noncalls <- c(noncalls_to_keep, calls_to_switch)
}
switched_votes <- symdiff(noncalls, old_noncalls)
if (length(switched_votes) <= vote_switch_percent * rc$m) {
match_counter <- match_counter + 1
} else {
match_counter <- 0
}
cat("Iteration", counter, "had", length(switched_votes), "out of", rc$m,
"switched votes\n")
}
rc$party_calls <- seq_len(rc$m)[-noncalls]
rc$record_of_coding <- record_of_coding
rc$record_of_pvals <- record_of_pvals
rc
}
code_party_calls(rc = h093, count_min = 1, count_max = 10, match_count_min = 2,
pval_threshold = 0.05, sim_annealing = FALSE, random_seed = FALSE)
# load data
options(stringsAsFactors = FALSE)
library(partycalls)
library(pscl)
library(emIRT)
load("inst/extdata/houKHfiles001-111.rdata")
# run current versions of functions
symdiff <- function(x, y)
{
sort(setdiff(base::union(x, y), base::intersect(x, y)))
}
test_rollcall <- function(.SD)
{
if (mean(.SD[, y], na.rm = TRUE) %in% c(0:1, NaN) |
length(unique(.SD[!is.na(y) & party %in% c("D", "R"), party])) == 1L) {
list(b = 0, se = 0, t = Inf, p = NA_real_)
} else if (length(unique(.SD[!is.na(y) & party %in% c("D"), y])) |
(length(unique(.SD[!is.na(y) & party %in% c("R"), y])))) {
list(b = 0, se = 0, t = Inf, p = 0)
} else {
m <- lm(y ~ party + x, data = .SD)
suppressWarnings(summ <- summary(m)$coef["partyR", ])
list(b = summ["Estimate"], se = summ["Std. Error"],
t = summ["t value"], p = summ["Pr(>|t|)"])
}
}
code_party_calls_1step <- function(rc, DT, noncalls)
{
rc1 <- rc
rc2 <- rc
rc1$votes <- rc$votes[, noncalls]
rc2$votes <- rc$votes[, -noncalls]
rc1$m <- ncol(rc1$votes)
rc2$m <- ncol(rc2$votes)
p <- makePriors(rc1$n, rc1$m, 1)
s <- getStarts(rc1$n, rc1$m, 1)
sink_target <- if (Sys.info()[["sysname"]] == "Windows") {
"NUL"
} else {
"/dev/null"
}
sink(sink_target)
l <- binIRT(.rc = rc1, .starts = s, .priors = p,
.control = list(threads = 1, verbose = FALSE, thresh = 1e-6))
sink()
unlink(sink_target)
DT$x <- l$means$x
regs <- DT[party %in% c("D", "R"), test_rollcall(.SD), .(vt)]
pvals <- regs$p
pvals[is.na(pvals)] <- 1
pvals
ok <- pvals > .05
which(ok)
}
code_party_calls <- function(rc, pval_threshold = 0.01, count_min = 15,
count_max = 150, match_count_min = 10, sim_annealing = TRUE,
random_seed = TRUE, lopside_thresh = 0.65, vote_switch_percent = 0.01)
{
rc <- pscl::dropRollCall(rc, dropList = alist(dropLegis = state == "USA"))
rc <- emIRT::convertRC(rc, type = "binIRT")
DT <- data.table::CJ(vt = colnames(rc$votes),
mc = rownames(rc$votes), sorted = FALSE)
DT$y <- as.vector(rc$votes)
DT$party <- rc$legis.data$party
DT[y %in% c(0, 9), y:= NA]
DT[y == -1, y:= 0]
if (random_seed == TRUE) {
noncalls <- sample(rc$m, floor(.5 * rc$m))
} else {
noncalls_DT <- DT[, yea_perc := mean(y, na.rm = TRUE), by = vt]
noncalls_DT <-
subset(DT, yea_perc < lopside_thresh & yea_perc > 1 - lopside_thresh,
select = vt)
noncalls_DT <- c(unique(noncalls_DT$vt))
noncalls <-
as.numeric(c(gsub(pattern = "Vote ", replacement = "", noncalls_DT)))
}
switched_votes <- seq_len(rc$m)
match_counter <- 0
counter <- 0
record_of_coding <- list()
record_of_pvals <- list()
while (counter <= count_min |
(counter < count_max & match_counter < match_count_min)) {
counter <- counter + 1
record_of_coding[[counter]] <- noncalls
old_noncalls <- noncalls
old_switched_votes <- switched_votes
pvals <- code_party_calls_1step(rc, DT, noncalls)
record_of_pvals[[counter]] <- pvals
noncalls <- which(pvals > pval_threshold)
calls <- setdiff(seq_len(rc$m), old_noncalls)
if (sim_annealing == TRUE) {
n_random_switches <- floor(rc$m * .2 * max(0, 1 - counter / 50) ^ 2)
} else {
n_random_switches <- 0
}
if (n_random_switches > 0) {
calls_to_switch <- sample(calls, n_random_switches)
noncalls_to_switch <- sample(noncalls, n_random_switches)
calls_to_keep <- setdiff(calls, calls_to_switch)
noncalls_to_keep <- setdiff(noncalls, noncalls_to_switch)
calls <- c(calls_to_keep, noncalls_to_switch)
noncalls <- c(noncalls_to_keep, calls_to_switch)
}
switched_votes <- symdiff(noncalls, old_noncalls)
if (length(switched_votes) <= vote_switch_percent * rc$m) {
match_counter <- match_counter + 1
} else {
match_counter <- 0
}
cat("Iteration", counter, "had", length(switched_votes), "out of", rc$m,
"switched votes\n")
}
rc$party_calls <- seq_len(rc$m)[-noncalls]
rc$record_of_coding <- record_of_coding
rc$record_of_pvals <- record_of_pvals
rc
}
code_party_calls(rc = h093, count_min = 1, count_max = 10, match_count_min = 2,
pval_threshold = 0.05, sim_annealing = FALSE, random_seed = FALSE)
library(partycalls)
options(stringsAsFactors = FALSE)
devtools::document()
devtools::build()
devtools::install()
load("inst/extdata/votedata-partycalls.rdata")
load("inst/extdata/houKHfiles001-111.rdata")
gsub("h0", "h")
sprintf("%03d", 93:111)
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
?sample.int
paste0("h", sprintf("%03d", 93:111))
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
house_party_calls <- lapply(100:111,
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", 100:111)
h001$m
?floor
floor(.5 * h001$m)
?sample
devtools::document()
devtools::build()
devtools::install()
h093$m
floor(.5 * h093$m)
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
code_party_calls(h093)
# build package
devtools::document()
devtools::build()
devtools::install()
# read in data
options(stringsAsFactors = FALSE)
library(partycalls)
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls(h093)
h93_test <- emIRT::convertRC(h093, type = "binIRT")
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc, random_seed = FALSE)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
?DT
rc <- h093
rc <- pscl::dropRollCall(rc, dropList = alist(dropLegis = state == "USA"))
rc <- emIRT::convertRC(rc, type = "binIRT")
DT <- data.table::CJ(vt = colnames(rc$votes),
mc = rownames(rc$votes), sorted = FALSE)
DT$y <- as.vector(rc$votes)
DT$party <- rc$legis.data$party
DT[y %in% c(0, 9), y:= NA]
DT[y == -1, y:= 0]
if (random_seed == TRUE) {
noncalls <- sample(rc$m, floor(.5 * rc$m))
} else {
noncalls_DT <- DT[, yea_perc := mean(y, na.rm = TRUE), by = vt]
noncalls_DT <-
subset(DT, yea_perc < lopside_thresh & yea_perc > 1 - lopside_thresh,
select = vt)
noncalls_DT <- c(unique(noncalls_DT$vt))
noncalls <-
as.numeric(c(gsub(pattern = "Vote ", replacement = "", noncalls_DT)))
}
noncalls_DT <- DT[, yea_perc := mean(y, na.rm = TRUE), by = vt]
noncalls_DT <-
subset(DT, yea_perc < lopside_thresh & yea_perc > 1 - lopside_thresh,
select = vt)
lopside_thresh <- .65
noncalls_DT <- DT[, yea_perc := mean(y, na.rm = TRUE), by = vt]
noncalls_DT <-
subset(DT, yea_perc < lopside_thresh & yea_perc > 1 - lopside_thresh,
select = vt)
noncalls_DT <- c(unique(noncalls_DT$vt))
noncalls <-
as.numeric(c(gsub(pattern = "Vote ", replacement = "", noncalls_DT)))
noncalls <- sample(rc$m, floor(.5 * rc$m))
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/votedata-partycalls.rdata")
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc, random_seed = FALSE)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/votedata-partycalls.rdata")
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc, random_seed = FALSE)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
h093$m
h094$m
h095$m
h096$m
h097$m
h098$m
h099$m
h100$m
h101$m
h102$m
h103$m
h104$m
h105$m
h106$m
h107$m
h108$m
h109$m
devtools::document()
devtools::build()
devtools::install()
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
devtools::document()
devtools::build()
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls(h093)
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls_by_congress_number_house <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", congress_number))
code_party_calls(rc)
}
house_party_calls <- lapply(sprintf("%03d", 93:111),
code_party_calls_by_congress_number_house)
names(house_party_calls) <- paste0("h", sprintf("%03d", 93:111))
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
h112 <- readKH("inst/extdata/hou112kh.ord")
set.seed(1584882915)
code_party_calls_by_congress_number <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", sprintf("%03.f", congress_number)))
code_party_calls(rc)
}
house_party_calls <- mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 4)
names(house_party_calls) <- paste0("hou", 93:112)
save(house_party_calls, file = "inst/extdata/house_party_calls.RData")
install.packages("parallel", dependencies = TRUE)
??mclapply
library(parallelsugar)
set.seed(1584882915)
code_party_calls_by_congress_number <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", sprintf("%03.f", congress_number)))
code_party_calls(rc)
}
house_party_calls <- mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 4)
set.seed(1584882915)
code_party_calls_by_congress_number <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", sprintf("%03.f", congress_number)))
code_party_calls(rc)
}
house_party_calls <- mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 4)
house_party_calls <- lapply(93:112, code_party_calls_by_congress_number)
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
library(parallelsugar)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
h112 <- readKH("inst/extdata/hou112kh.ord")
set.seed(1584882915)
code_party_calls_by_congress_number <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", sprintf("%03.f", congress_number)))
code_party_calls(rc)
}
house_party_calls <- lapply(93:112, code_party_calls_by_congress_number)
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
library(parallelsugar)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
h112 <- readKH("inst/extdata/hou112kh.ord")
set.seed(1584882915)
code_party_calls_by_congress_number <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", sprintf("%03.f", congress_number)))
code_party_calls(rc)
}
house_party_calls <- lapply(93:112, code_party_calls_by_congress_number)
house_party_calls <- mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 2)
devtools::document()
devtools::build()
devtools::install()
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
library(parallelsugar)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
h112 <- readKH("inst/extdata/hou112kh.ord")
set.seed(1584882915)
code_party_calls_by_congress_number <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", sprintf("%03.f", congress_number)))
code_party_calls(rc)
}
house_party_calls <- lapply(93:112, code_party_calls_by_congress_number)
?mclapply
devtools::document()
devtools::build()
devtools::install()
library(partycalls)
library(parallel)
options(stringsAsFactors = FALSE)
load("inst/extdata/houKHfiles001-111.rdata")
code_party_calls(h093)
h112 <- readKH("inst/extdata/hou112kh.ord")
set.seed(1584882915)
code_party_calls_by_congress_number <- function(congress_number)
{
cat("**** working on house", congress_number, "\n")
rc <- get(paste0("h", sprintf("%03.f", congress_number)))
code_party_calls(rc)
}
house_party_calls <- mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 4)
library(parallelsugar)
house_party_calls <- mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 4)
?detectCores
detectCores
detectCores()
house_party_calls <- mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 2)
house_party_calls <- parallelsugar::mclapply(93:112, code_party_calls_by_congress_number,
mc.cores = 2)
house_party_calls <- lapply(93:112, code_party_calls_by_congress_number)
house_party_calls <- lapply(93:112, code_party_calls_by_congress_number)
names(house_party_calls) <- paste0("hou", 93:112)
save(house_party_calls, file = "inst/extdata/house_party_calls.RData")
h112 <- readKH("inst/extdata/hou112kh.ord")
?readKH
library(pscl)
